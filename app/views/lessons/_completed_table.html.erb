<script>
function showGroupLesson(group_lesson_id) {
  console.log("show .group-lesson-"+group_lesson_id);
  $(".group-lesson-"+group_lesson_id).show();
  $(".expand-button-"+group_lesson_id).hide();
}
function hideGroupLesson(group_lesson_id) {
  console.log("hide .group-lesson-"+group_lesson_id);
  $(".group-lesson-"+group_lesson_id).hide();
  $(".expand-button-"+group_lesson_id).show();
}
</script>
<table>
<tr>
<!-- post to /dateviews where new date is stored, then redirect back here -->
<%= form_for @dateview, url: dateviews_path do |f| %>
  <td>
  <%= f.label :start_date %>
  </td>
  <td>
  <%= f.text_field :s_date_formatted, class: "date" %>
  </td>
  <td>
  <%= f.label :end_date %>
  </td>
  <td>
  <%= f.text_field :e_date_formatted, class: "date"  %>
  </td>
  <td>
  Total hours
  </td>
  <td>
  <%= number_with_precision(@tot_hours, :precision => 2) || 0  %>
  </td>
  <td>
  <td><%= f.submit "Update Table", class: "updatetab" %></td>
  </td>
<% end %>
</tr>
</table>
<table class="stdnt">
  <tr>
    <th class="no-border-left"></th>
    <% if @showschool %>
      <th>
        <%= form_for("School", url: lessons_sort_path) do |f| %>
        <% f.submit "School", name: "sortcol" %>
        <% end %>
      </th>
    <% end %>
    <% if @showteacher %>
      <th colspan="2">
        <%= form_for("Teacher", url: lessons_sort_path) do |f| %>
        <% f.submit "Teacher", name: "sortcol" %>
        <% end %>
      </th>
    <% end %>
    <% if @showstudent %>
    <th colspan="2">
      <%= form_for("Student", url: lessons_sort_path) do |f| %>
      <% f.submit "Student", name: "sortcol" %>
      <% end %>
    </th>
    <% end %>
		<th class="date">
      <%= form_for("Date", url: lessons_sort_path) do |f| %>
      <% f.submit "Date", name: "sortcol" %>
      <% end %>
    </th>
    <% if @showhours %>
    <th>
      Time In
    </th>
    <th>
      Time Out
    </th>
    <th>
      Minutes
    </th>
    <% end %>
    <th class="cent">
      <%= form_for("Progress", url: lessons_sort_path) do |f| %>
      <% f.submit "Progress", name: "sortcol" %>
      <% end %>
    </th>
    <th class="cent">
      <%= form_for("Behavior", url: lessons_sort_path) do |f| %>
      <% f.submit "Behavior", name: "sortcol" %>
      <% end %>
    </th>
    <th class="cent">
      Brought Instrument
    </th>
    <th class="cent">
      Brought Books
    </th>
    <th>
      Notes
    </th>
	</tr>
  <% if @lessons.length > 0 %>
    <% current_gid = nil %>
    <% @lessons.each do |lesson| %>
    <% # Last row of group lesson
      if current_gid && (!lesson.group_lesson_id || current_gid != lesson.group_lesson_id)
    %>
    <tr class="group-lesson-row group-lesson-<%= current_gid %>">
      <td class="no-border-left"></td><td colspan="12">Group Lesson Notes:<br><%= GroupLesson.find(current_gid).notes %></td>
    </tr>
    <%  
        current_gid = nil
        end 
    %>
    <% # First row of group lesson
      if lesson.group_lesson_id && (!current_gid || current_gid != lesson.group_lesson_id)
        current_gid = lesson.group_lesson_id # start new group lesson
    %>
    <tr class="group-lesson-heading">
      <td class="no-border-left"><button class="minimize expand-button-<%= current_gid %>" onclick="showGroupLesson(<%= current_gid %>);">+</button>
      <button class="minimize hidden group-lesson-<%= current_gid %>" onclick="hideGroupLesson(<%= current_gid %>)">-</button></td>
      <td><%= lesson.student.school.name %></td>
      <td colspan="2">Group Lesson</td>
      <td><%= lesson['time_in'].strftime("%m-%d-%Y") %></td>
      <% if @showhours %>
        <td><%= lesson.time_in.strftime("%l:%M %p") %></td>
        <td><%= lesson.time_out.strftime("%l:%M %p") %></td>
        <td>
          <%= number_with_precision((lesson.time_out - lesson.time_in)/60, :precision =>2) || 0 %>
        </td>
      <% end %>
      <td colspan="5">Group Lesson</td>
    </tr>
    <% end %>
    <tr class="<%= lesson.group_lesson_id ? "group-lesson-row group-lesson-#{current_gid}" : "single-lesson-row" %>">
      <td class="no-border-left"></td>
      <% if @showschool %>
        <td><%= lesson['name'] %> </td>
      <% end %>
      <% if @showteacher %>
        <td><%= lesson.teacher['first_name'] %> </td>
        <td><%= lesson.teacher['last_name'] %> </td>
      <% end %>
      <% if @showstudent %>
        <td><%= lesson.student['first_name'] %> </td>
        <td><%= lesson.student['last_name'] %> </td>
      <% end %>
      <td><%= lesson['time_in'].strftime("%m-%d-%Y") %></td>
      <% if @showhours %>
        <td><%= lesson.time_in.strftime("%l:%M %p") %></td>
        <td><%= lesson.time_out.strftime("%l:%M %p") %></td>
        <td>
          <%= number_with_precision((lesson.time_out - lesson.time_in)/60, :precision =>2) || 0 %>
        </td>
  
      <% end %>
      <td class="cent"><%= lesson['progress'] %> </td>
      <td class="cent"><%= lesson['behavior'] %> </td>
      <td class="cent">
        <%= if lesson['brought_instrument'] then "Y" else "N" end %>
      </td>
      <td class="cent">
        <%= if lesson['brought_books'] then "Y" else "N" end %> 
      </td>
      <td><%= lesson['notes'] %> </td>
    </tr>
    <% end %>
  <% else %>
    <tr><th colspan="12">None.</th></tr>
  <% end %>
</table>
